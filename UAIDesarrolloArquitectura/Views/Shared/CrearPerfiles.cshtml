@model UAIDesarrolloArquitectura.Models.ViewModel.CrearPerfilViewModel
@using Services.Models
<!DOCTYPE html>
<html>
@{
 ViewBag.Title = "CrearPerfiles";
 Services.Idioma.Translator translator = new Services.Idioma.Translator();
 UAIDesarrolloArquitectura.Controllers.IdiomaController lC = new UAIDesarrolloArquitectura.Controllers.IdiomaController();
 lC.InitializeController();
 Services.LanguageService service = lC.GetService();
 service.Susbcribe(translator);
 if (Services.SessionManager.IsLogged()) { service.ChangeLanguage((Services.SessionManager.GetInstance.User.LanguageId).ToString()); }
 else { if (!service.SelectedLanguageExists()) { service.ChangeLanguage("1"); } }
}
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>Creación de Perfiles</title>
 <link rel="stylesheet" href="~/Content/Site.css">
 <link rel="preconnect" href="https://fonts.googleapis.com">
 <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
 <link href="https://fonts.googleapis.com/css2?family=Chivo:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
 <style>
 ul.tree, ul.tree ul { list-style-type:none; margin:0; padding:0; }
 ul.tree ul { margin-left:20px; display:block; }
 li.Role { margin:5px0; text-align:left; }
 li.Role::before { content:'▶'; display:inline-block; cursor:pointer; margin-right:5px; }
 li.Role.open::before { content:'▼'; }
 li.Permission { margin:5px0; text-align:left; }
 .container { display:flex; justify-content:center; align-items:center; gap:5px; }
 .form-container { margin:20px; padding:20px; background-color:white; border:1px solid #ccc; width:300px; display:flex; flex-direction:column; gap:15px; }
 .form-item { display:flex; flex-direction:column; gap:5px; }
 select, input[type="text"] { padding:8px; font-size:14px; border:1px solid #ccc; border-radius:4px; }
 input[type="button"] { width:auto; padding:10px; background-color:#2d53fd; color:white; border:none; border-radius:4px; cursor:pointer; }
 input[type="button"]:hover { background-color:#5270fa; }
 .container-tree { width:300px; height:400px; background-color:white; border:2px solid #ccc; padding:10px; box-shadow:04px8px rgba(0,0,0,0.1); }
 footer { background-color:#2E7D32; color:white; padding:10px; text-align:center; }
 </style>
</head>
<body>
 <!-- Navbar from Index -->
 <nav class="barra">
 @if (Services.SessionManager.IsLogged())
 {
 <div id="opciones" class="opciones">
 <a href="@Url.Action("Logout", "Home")">@translator.GetTraduction(service, "Logout")</a>
 <a style="display:none;" id="bitacora" href="@Url.Action("Bitacora", "Bitacora")">@translator.GetTraduction(service, "Log")</a>
 <a style="display:none;" id="abmusuarios" href="@Url.Action("ABMUsuarios", "ABM")">@translator.GetTraduction(service, "ManageUser")</a>
 <a style="display:none;" id="restore" href="@Url.Action("BackupRestore", "Backup")">@translator.GetTraduction(service, "Restoredb")</a>
 <a style="display:none;" id="1001" href="@Url.Action("ABMIdioma", "Idioma")">@translator.GetTraduction(service, "ManageLanguage")</a>
 <a style="display:none;" id="1002" href="@Url.Action("CrearPerfiles", "CrearPerfiles")">@translator.GetTraduction(service, "CreateProfile")</a>
 <a style="display:none;" id="1003" href="@Url.Action("AsignarPerfil", "AsignarPerfil")">@translator.GetTraduction(service, "AssignProfile")</a>
 <script type="text/javascript">
 @foreach (string permission in Services.SessionManager.GetInstance.User.permissionList)
 {<text>document.getElementById('@permission').style.display='block';</text>}
 </script>
 </div>
 <div class="opciones"><p style="color: white;">@translator.GetTraduction(service, "Welcome"), @Services.SessionManager.GetInstance.User.Name</p></div>
 }
 else
 {
 <a href="@Url.Action("Login", "Login")">@translator.GetTraduction(service, "Login")</a>
 <a href="@Url.Action("Register", "Register")">@translator.GetTraduction(service, "Register")</a>
 }
 <form>
 <select id="option" onchange="enviarValor()">
 @foreach (Services.Idioma.Language l in service.GetLanguages())
 { if (service.SelectedLanguage.Id == l.Id) {<option value="@l.Id" selected="selected">@translator.GetTraduction(service, l.Name)</option>} else {<option value="@l.Id">@translator.GetTraduction(service, l.Name)</option>} }
 </select>
 </form>
 </nav>
 <header><h1 style="color:#2E7D32;">AgroMinds</h1></header>
 <nav class="menu-secundario">
 <a href="@Url.Action("Index", "Home")">@translator.GetTraduction(service, "Main")</a>
 <a href="@Url.Action("Plans", "Home")">@translator.GetTraduction(service, "Plans")</a>
 <a href="@Url.Action("Servicios", "Home")">@translator.GetTraduction(service, "Services")</a>
 <a href="@Url.Action("Nosotros", "Home")">@translator.GetTraduction(service, "AboutUs")</a>
 <a href="@Url.Action("Contact", "Home")">@translator.GetTraduction(service, "Contact")</a>
 </nav>
 <!-- Original page content -->
 <div class="container">
 <div class="form-container">
 <div class="form-item">
 <h5>@translator.GetTraduction(service, "Roles")</h5>
 <select id="selRole">
 @foreach (var role in Model.Roles) { <option>@role.Name</option> }
 </select>
 <input id="btnAgregarRol" type="button" value="Agregar Rol" />
 </div>
 <div class="form-item">
 <h5>@translator.GetTraduction(service, "Permissions")</h5>
 <select id="selPermission">
 @foreach (var permiso in Model.Permisos) { <option value="@permiso.Id">@permiso.Name</option> }
 </select>
 <input id="btnAgregarPermiso" type="button" value="@translator.GetTraduction(service, "AddPermission")" />
 </div>
 <div class="form-item">
 <h5>@translator.GetTraduction(service, "ProfileName"):</h5>
 <input id="txtNombrePerfil" type="text" />
 <br />
 <input id="btnAgregarPerfil" type="button" value="@translator.GetTraduction(service, "AddProfile")" />
 </div>
 </div>
 <div class="container-tree">
 <ul id="arbol" class="tree"><li id="liPerfil" class="Role" style="display:none"></li></ul>
 </div>
 <input id="crearPerfil" type="button" value="@translator.GetTraduction(service, "CreateProfile2")" />
 </div>
 <script>
 let liProfileName=document.getElementById("liPerfil"); let nombreperfil;
 function expandNode(n){ n.style.display='block'; } function colapseNode(n){ n.style.display='none'; }
 function alternateSubListVisibility(e){ e.stopPropagation(); this.classList.toggle('open'); let childList=this.querySelector('ul'); if(childList){ childList.style.display!='none'?colapseNode(childList):expandNode(childList);} }
 function assignClickEvents(){ document.querySelectorAll('ul.tree li').forEach(li=>li.addEventListener('click',alternateSubListVisibility)); }
 assignClickEvents();
 function permissionExists(t){ let ex=false; document.querySelectorAll('ul.tree li').forEach(p=>{ if(p.textContent===t) ex=true; }); return ex; }
 document.getElementById("btnAgregarPerfil").addEventListener('click',()=>{ nombreperfil=document.getElementById("txtNombrePerfil").value; if(nombreperfil=="") alert("Debe darle un nombre al perfil!!"); else { liProfileName.style.display='block'; liProfileName.innerText=nombreperfil; } });
 document.getElementById("btnAgregarPermiso").addEventListener('click',()=>add('Permission'));
 document.getElementById("btnAgregarRol").addEventListener('click',()=>{ const sel=document.getElementById('selRole'); const selectedRoleText=sel.options[sel.selectedIndex].text; if(!selectedRoleText) return; nombreperfil=selectedRoleText; liProfileName.style.display='block'; liProfileName.innerText=nombreperfil; });
 function add(auth){ const selAuth=document.getElementById(`sel${auth}`); let selectedAuthText=selAuth.options[selAuth.selectedIndex].text; if(liProfileName.style.display=="none"){ alert("No se creó el perfil"); return;} if(permissionExists(selectedAuthText)){ alert("Este permiso ya existe"); return;} let liAuth=document.createElement("li"); liAuth.textContent=selectedAuthText; liAuth.className=auth; let ulAuth=liProfileName.querySelector('ul'); if(!ulAuth){ ulAuth=document.createElement('ul'); liProfileName.appendChild(ulAuth);} ulAuth.appendChild(liAuth); }
 document.getElementById('crearPerfil').addEventListener('click', enviarPerfil);
 function enviarPerfil(){ const permisos=[]; document.querySelectorAll('ul.tree ul li').forEach(i=>permisos.push({ nombre:i.textContent.trim() })); const perfilData={ nombrePerfil:nombreperfil, permisos:permisos }; fetch('/CrearPerfiles/GuardarPerfil',{ method:'POST', headers:{ 'Content-Type':'application/json' }, body:JSON.stringify(perfilData) }).then(r=>{ if(!r.ok) throw new Error("Error en la solicitud: "+r.status); return r.json(); }).then(d=>{ if(d.success) alert("Perfil creado exitosamente!"); else alert("Hubo un problema al crear el perfil: "+d.error); }).catch(err=>console.error('Error:',err)); }
 </script>
 <script src="~/Scripts/scriptIdioma.js"></script>
 <footer>©2026 AgroMinds — Tecnología agrícola inteligente. Todos los derechos reservados.</footer>
</body>
</html>
