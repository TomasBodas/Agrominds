@using Services.Models
@model IDictionary<int, IList<TelemetriaRobot>>
<!DOCTYPE html>
<html lang="es">
@{
 ViewBag.Title = "Telemetría";
 Services.Idioma.Translator translator = new Services.Idioma.Translator();
 UAIDesarrolloArquitectura.Controllers.IdiomaController lC = new UAIDesarrolloArquitectura.Controllers.IdiomaController();
 lC.InitializeController();
 Services.LanguageService service = lC.GetService();
 service.Susbcribe(translator);
 if (Services.SessionManager.IsLogged()) { service.ChangeLanguage((Services.SessionManager.GetInstance.User.LanguageId).ToString()); }
 else { if (!service.SelectedLanguageExists()) { service.ChangeLanguage("1"); } }
 var robots = ViewBag.Robots as IList<Robot> ?? new List<Robot>();
}
<head>
 <meta charset="UTF-8" />
 <meta name="viewport" content="width=device-width, initial-scale=1.0" />
 <title>Telemetría</title>
 <link rel="stylesheet" href="~/Content/Site.css" />
 <link rel="preconnect" href="https://fonts.googleapis.com" />
 <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
 <link href="https://fonts.googleapis.com/css2?family=Chivo:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet" />
 <style>
 body { font-family: 'Chivo', Arial, sans-serif; background: #f5faf5; }
 .layout { display: flex; min-height: calc(100vh -60px); }
 .sidebar { width:240px; background: #e8f5e9; border-right:1px solid #a5d6a7; padding:16px; position: sticky; top:0; height:100vh; }
 .sidebar a { display:flex; align-items:center; gap:8px; color:#1b5e20; text-decoration:none; padding:8px 10px; border-radius:6px; margin-bottom:6px; font-weight:600; }
 .sidebar a .ico { width:18px; height:18px; display:inline-flex; }
 .sidebar a:hover { background:#c8e6c9; }
 .content { flex:1; padding:32px 48px 40px; }
 .wrapper { max-width:1180px; margin:0 auto; }
 .section { margin-bottom:40px; }
 .section h2 { font-size:22px; color: #2E7D32; margin: 0 0 14px 0; }
 .tele-list { display: flex; flex-direction: column; gap:14px; }
 .tele-item { background: #fff; border:1px solid #d8e2d8; border-radius:14px; padding:14px 20px; box-shadow: 2px 8px rgba(46,125,50,0.10); display: flex; justify-content: space-between; align-items: center; }
 .tele-item:hover { box-shadow: 4px 14px rgba(46,125,50,0.14); }
 .meta { font-size:13px; color: #1b5e20; line-height:1.4; }
 .actions { display: flex; gap:8px; }
 .btn { border: none; cursor: pointer; padding:8px 14px; font-size:12px; font-weight:600; border-radius:12px; background: #2E7D32; color: #fff; }
 .btn:hover { background: #1b5e20; }
 .empty { background: #fff; border:1px dashed #cfe0cf; padding:20px; border-radius:14px; text-align: center; color: #1b5e20; font-weight:600; }
 .estado { display: inline-block; padding:2px 8px; border-radius:8px; font-size:11px; font-weight:700; background: #c8e6c9; color: #1b5e20; }
 </style>
</head>
<body>
 <nav class="barra">
 @if (Services.SessionManager.IsLogged())
 {
 <div id="opciones" class="opciones">
 <a href="@Url.Action("Logout","Home")">@translator.GetTraduction(service, "Logout")</a>
 <a style="display:none;" id="bitacora" href="@Url.Action("Bitacora","Bitacora")">@translator.GetTraduction(service, "Log")</a>
 <a style="display:none;" id="abmusuarios" href="@Url.Action("ABMUsuarios","ABM")">@translator.GetTraduction(service, "ManageUser")</a>
 <a style="display:none;" id="restore" href="@Url.Action("BackupRestore","Backup")">@translator.GetTraduction(service, "Restoredb")</a>
 <a style="display:none;" id="1001" href="@Url.Action("ABMIdioma","Idioma")">@translator.GetTraduction(service, "ManageLanguage")</a>
 <a style="display:none;" id="1002" href="@Url.Action("CrearPerfiles","CrearPerfiles")">@translator.GetTraduction(service, "CreateProfile")</a>
 <a style="display:none;" id="1003" href="@Url.Action("AsignarPerfil","AsignarPerfil")">@translator.GetTraduction(service, "AssignProfile")</a>
 <script type="text/javascript">@foreach (string permission in Services.SessionManager.GetInstance.User.permissionList){<text>document.getElementById('@permission').style.display='block';</text>}</script>
 </div>
 <div class="opciones"><p style="color: white;">@translator.GetTraduction(service, "Welcome"), @Services.SessionManager.GetInstance.User.Name</p></div>
 }
 else
 {
 <a href="@Url.Action("Login","Login")">@translator.GetTraduction(service, "Login")</a>
 <a href="@Url.Action("Register","Register")">@translator.GetTraduction(service, "Register")</a>
 }
 <form>
 <select id="option" onchange="enviarValor()">@foreach (Services.Idioma.Language l in service.GetLanguages())
 {
 if (service.SelectedLanguage.Id == l.Id)
 {<option value="@l.Id" selected>@translator.GetTraduction(service, l.Name)</option>}
 else
 {<option value="@l.Id">@translator.GetTraduction(service, l.Name)</option>}
 }</select>
 </form>
 </nav>
 <div class="layout">
     <aside class="sidebar">
         <a href="@Url.Action("Robots","Home")">@translator.GetTraduction(service, "RobotsManagement")</a>
         <a href="@Url.Action("Mantenimientos","Home")">@translator.GetTraduction(service, "Maintenance")</a>
         <a href="@Url.Action("Telemetria","Home")" class="active">@translator.GetTraduction(service, "Telemetry")</a>
         <a href="@Url.Action("ContactUs","Home")">@translator.GetTraduction(service, "Contact")</a>
     </aside>
 <main class="content">
 <div class="wrapper">
 @if (robots.Count ==0)
 {<div class="empty">No hay robots registrados</div> }
 else
 {
 foreach (var robot in robots)
 {
 var lista = Model.ContainsKey(robot.Id) ? Model[robot.Id] : new List<TelemetriaRobot>();
 <div class="section" id="robot-@robot.Id">
 <h2>@robot.Nombre (@robot.NumeroSerie)</h2>
 @if (lista.Count ==0)
 {
 <div class="empty">Sin registros de telemetría</div>
 }
 else
 {
 <div class="tele-list">
 @foreach (var t in lista)
 {
 <div class="tele-item" data-id="@t.Id">
 <div class="meta">
 <strong>Fecha:</strong> @t.FechaHora.ToString("yyyy-MM-dd HH:mm")<br />
 @if (t.NivelBateria.HasValue)
 {<span><strong>Batería:</strong> @t.NivelBateria.Value %</span><br />}
 @if (t.Temperatura.HasValue)
 {<span><strong>Temp:</strong> @t.Temperatura.Value.ToString("0.##") °C</span><br />}
 @if (!string.IsNullOrWhiteSpace(t.Estado))
 {<span><strong>Estado:</strong> <span class="estado">@t.Estado</span></span><br />}
 @if (!string.IsNullOrWhiteSpace(t.DatosJSON))
 {<span><strong>Datos:</strong> <small>@(t.DatosJSON.Length >90 ? t.DatosJSON.Substring(0,90)+"..." : t.DatosJSON)</small></span>}
 </div>
 <div class="actions">
 <button class="btn" onclick="detalle(@t.Id)">Detalle</button>
 </div>
 </div>
 }
 </div>
 }
 </div>
 }
 }
 </div>
 </main>
 </div>
 <footer>©2026 AgroMinds — Tecnología agrícola inteligente.</footer>
 <script>
 function detalle(id) { alert('Detalle telemetría ' + id); }
 </script>
</body>
</html>