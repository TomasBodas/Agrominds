@using Services.Models
@model IList<Robot>
<!DOCTYPE html>
<html lang="es">
@{
	ViewBag.Title = "Robots";
	Services.Idioma.Translator translator = new Services.Idioma.Translator();
	UAIDesarrolloArquitectura.Controllers.IdiomaController lC = new UAIDesarrolloArquitectura.Controllers.IdiomaController();
	lC.InitializeController();
	Services.LanguageService service = lC.GetService();
	service.Susbcribe(translator);
	if (Services.SessionManager.IsLogged()) { service.ChangeLanguage((Services.SessionManager.GetInstance.User.LanguageId).ToString()); }
	else { if (!service.SelectedLanguageExists()) { service.ChangeLanguage("1"); } }
	// Estados provistos por la BLL vía el controlador
	var estados = (Dictionary<int,string>) (ViewBag.EstadosRobot ?? new Dictionary<int,string>());
}
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Robots</title>
	<link rel="stylesheet" href="~/Content/Site.css" />
	<link rel="preconnect" href="https://fonts.googleapis.com" />
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
	<link href="https://fonts.googleapis.com/css2?family=Chivo:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet" />
	<style>
		body { font-family:"Chivo", Arial, sans-serif; background:#f5faf5; }
		.layout { display:flex; min-height:calc(100vh -60px); }
		.sidebar { width:240px; background:#e8f5e9; border-right:1px solid #a5d6a7; padding:16px; position:sticky; top:0; height:100vh; }
		.sidebar a { display:block; color:#1b5e20; text-decoration:none; padding:8px 10px; border-radius:6px; margin-bottom:6px; font-weight:600; }
		.sidebar a:hover { background:#c8e6c9; }
		.content { flex:1; padding:32px 48px 40px; }
		.robots-wrapper { max-width:1180px; margin:0 auto; }
		.filter-bar { background:#ffffff; border:1px solid #d8e2d8; border-radius:14px; padding:12px 16px; margin:0 0 16px 0; display:flex; align-items:center; gap:12px; }
		.filter-bar label { font-weight:600; color:#1b5e20; }
		.filter-bar select { padding:6px 10px; border:1px solid #cfe0cf; border-radius:8px; }
		.robot-list { display:flex; flex-direction:column; gap:20px; }
		.robot-item { background:#ffffff; border:1px solid #d8e2d8; border-radius:20px; padding:20px 28px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 4px 10px rgba(46,125,50,0.12); animation:fadeIn .5s ease; transition:box-shadow .25s, transform .15s; }
		.robot-item:hover { box-shadow:0 6px 16px rgba(46,125,50,0.18); transform:translateY(-2px); }
		.dark .robot-item { background:#2b2b2b; border-color:#444; }
		@@keyframes fadeIn { from { opacity:0; transform:translateY(12px);} to { opacity:1; transform:translateY(0);} }
		.robot-info h3 { margin:0 0 6px 0; font-size:21px; font-weight:700; color:#2E7D32; letter-spacing:.4px; }
		.robot-info p { margin:2px 0; font-size:14px; color:#1b5e20; }
		.status-pill { display:inline-block; padding:5px 12px; font-size:12px; font-weight:600; border-radius:16px; background:#e8f5e9; color:#1b5e20; box-shadow:0 0 1px rgba(46,125,50,.12); }
		.status-activo { background:#e3f2fd; color:#1565c0; }
		.status-mantenimiento { background:#fff8e1; color:#ff8f00; }
		.status-apagado { background:#ffebee; color:#c62828; }
		.status-disponible { background:#e8f5e9; color:#1b5e20; }
		.battery-wrap { margin-top:8px; display:flex; align-items:center; gap:12px; }
		.battery-bar { width:160px; height:12px; background:#ececec; border-radius:8px; overflow:hidden; position:relative; }
		.battery-fill { height:100%; background:linear-gradient(90deg,#66bb6a,#43A047); transition:width .6s; }
		.battery-low .battery-fill { background:linear-gradient(90deg,#ef5350,#c62828); }
		.robot-actions { display:flex; gap:12px; }
		.btn { cursor:pointer; border:none; font-size:13px; font-weight:600; display:inline-flex; align-items:center; gap:8px; padding:11px 18px; border-radius:16px; line-height:1; position:relative; overflow:hidden; background:#2E7D32; color:#fff; transition:background .25s, transform .15s, box-shadow .25s; }
		.btn::before { content:""; position:absolute; inset:0; background:linear-gradient(135deg, rgba(255,255,255,.15), rgba(255,255,255,0)); opacity:0; transition:opacity .25s; }
		.btn:hover::before { opacity:1; }
		.btn:active { transform:scale(.95); }
		.btn-power-activo { background:linear-gradient(135deg,#d32f2f,#b71c1c); }
		.btn-power-activo:hover { background:linear-gradient(135deg,#e53935,#c62828); }
		.btn-power-inactivo { background:linear-gradient(135deg,#2E7D32,#43A047); }
		.btn-power-inactivo:hover { background:linear-gradient(135deg,#1b5e20,#2E7D32); }
		.btn-config { background:linear-gradient(135deg,#eceff1,#cfd8dc); color:#2b2b2b; }
		.btn-config:hover { background:linear-gradient(135deg,#dfe4e6,#c5ced2); }
		.empty-msg { background:#fff; border:1px dashed #cfe0cf; padding:48px 32px; border-radius:24px; font-weight:600; color:#1b5e20; text-align:center; }
		footer { background:#2E7D32; color:#fff; padding:14px; text-align:center; }
		@@media (max-width:768px){ .content { padding:28px 20px; } .robot-item { flex-direction:column; align-items:flex-start; } .robot-actions { width:100%; justify-content:flex-start; flex-wrap:wrap; } .robot-actions .btn { flex:1; } }
	</style>
</head>
<body>
	<nav class="barra">
		@if (Services.SessionManager.IsLogged()) {
			<div id="opciones" class="opciones">
				<a href="@Url.Action("Logout","Home")">@translator.GetTraduction(service,"Logout")</a>
				<a style="display:none;" id="bitacora" href="@Url.Action("Bitacora","Bitacora")">@translator.GetTraduction(service,"Log")</a>
				<a style="display:none;" id="abmusuarios" href="@Url.Action("ABMUsuarios","ABM")">@translator.GetTraduction(service,"ManageUser")</a>
				<a style="display:none;" id="restore" href="@Url.Action("BackupRestore","Backup")">@translator.GetTraduction(service,"Restoredb")</a>
				<a style="display:none;" id="1001" href="@Url.Action("ABMIdioma","Idioma")">@translator.GetTraduction(service,"ManageLanguage")</a>
				<a style="display:none;" id="1002" href="@Url.Action("CrearPerfiles","CrearPerfiles")">@translator.GetTraduction(service,"CreateProfile")</a>
				<a style="display:none;" id="1003" href="@Url.Action("AsignarPerfil","AsignarPerfil")">@translator.GetTraduction(service,"AssignProfile")</a>
				<script type="text/javascript">@foreach (string permission in Services.SessionManager.GetInstance.User.permissionList){<text>document.getElementById('@permission').style.display='block';</text>}</script>
			</div>
			<div class="opciones"><p style="color:white;">@translator.GetTraduction(service,"Welcome"), @Services.SessionManager.GetInstance.User.Name</p></div>
		} else {
			<a href="@Url.Action("Login","Login")">@translator.GetTraduction(service,"Login")</a>
			<a href="@Url.Action("Register","Register")">@translator.GetTraduction(service,"Register")</a>
		}
		<form>
			<select id="option" onchange="enviarValor()">@foreach (Services.Idioma.Language l in service.GetLanguages()){ if (service.SelectedLanguage.Id==l.Id){<option value="@l.Id" selected>@translator.GetTraduction(service,l.Name)</option>} else {<option value="@l.Id">@translator.GetTraduction(service,l.Name)</option>} }</select>
		</form>
	</nav>
	<div class="layout">
 <aside class="sidebar">
 <a href="@Url.Action("Robots","Home")" class="active">@translator.GetTraduction(service,"RobotsManagement")</a>
 <a href="@Url.Action("Mantenimientos","Home")">@translator.GetTraduction(service,"Maintenance")</a>
 <a href="@Url.Action("Telemetria","Home")">@translator.GetTraduction(service,"Telemetry")</a>
 <a href="@Url.Action("ContactUs","Home")">@translator.GetTraduction(service,"Contact")</a>
 </aside>
		<main class="content">
			<div class="robots-wrapper">
			@if (Model == null || Model.Count ==0) {
				<div class="empty-msg">@translator.GetTraduction(service,"NoRobots")</div>
			} else {
				<div class="filter-bar">
					<label for="estadoFilter">@translator.GetTraduction(service,"FilterByState"):</label>
					<select id="estadoFilter">
						<option value="all">@translator.GetTraduction(service,"All")</option>
						@foreach (var kv in estados)
						{
							<option value="@kv.Key">@translator.GetTraduction(service, kv.Value)</option>
						}
					</select>
				</div>
				<div class="robot-list">
					@foreach (var r in Model) {
						var bateriaPct = r.Bateria <0 ?0 : (r.Bateria >100 ?100 : r.Bateria);
						string estadoNombreRaw = estados.ContainsKey(r.IdEstadoRobot) ? estados[r.IdEstadoRobot] : r.IdEstadoRobot.ToString();
						string estadoNombreTraducido = translator.GetTraduction(service, estadoNombreRaw);
						string estadoClass = estadoNombreRaw.ToLower().Replace(" ","-");
						bool activo = r.IdEstadoRobot ==2;
						var botonPowerTexto = activo ? translator.GetTraduction(service,"Stop") : translator.GetTraduction(service,"Activate");
						var siguienteEstadoPower = activo ?4 :2;
						<div class="robot-item" data-id="@r.Id" data-state="@r.IdEstadoRobot">
							<div class="robot-info">
								<h3>@r.Nombre</h3>
								<p><strong>@translator.GetTraduction(service, "State"):</strong> <span class="status-pill status-@estadoClass">@estadoNombreTraducido</span></p>
								<p><strong>@translator.GetTraduction(service, "Battery"):</strong></p>
								<div class="battery-wrap @(bateriaPct<=15?"battery-low":"")">
									<div class="battery-bar"><div class="battery-fill" style="width:@bateriaPct;"></div></div>
									<span class="battery-label">@bateriaPct%</span>
								</div>
							</div>
							<div class="robot-actions">
								<button type="button" class="btn @(activo?"btn-power-activo":"btn-power-inactivo") btn-power" data-id="@r.Id" data-next="@siguienteEstadoPower">@botonPowerTexto</button>
								<button type="button" class="btn btn-config" data-id="@r.Id">@translator.GetTraduction(service,"Configure")</button>
							</div>
						</div>
					}
				</div>
			}
			</div>
		</main>
	</div>
	<footer>©2026 AgroMinds — Tecnología agrícola inteligente. Todos los derechos reservados.</footer>
	<script src="~/Scripts/scriptIdioma.js"></script>
	<script>
	(function(){
		function post(url,data){return fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)}).then(r=>r.json());}
		document.querySelectorAll('.btn-config').forEach(b=>b.addEventListener('click',function(){var id=this.getAttribute('data-id');window.location='/Robot/Details/'+id;}));
		document.querySelectorAll('.btn-power').forEach(b=>b.addEventListener('click',function(){var id=this.getAttribute('data-id');var next=this.getAttribute('data-next');post('/Robot/ChangeState',{id:parseInt(id),newState:parseInt(next)}).then(resp=>{if(resp.success){location.reload();}else{alert(resp.error||'Error');}}).catch(()=>alert('Error de conexión'));}));
		var sel=document.getElementById('estadoFilter');
		if(sel){ sel.addEventListener('change', function(){ var v=this.value; var items=document.querySelectorAll('.robot-item'); items.forEach(function(it){ var st=it.getAttribute('data-state'); if(v==='all' || v===st){ it.style.display='flex'; } else { it.style.display='none'; } }); }); }
	})();
	</script>
</body>
</html></html>